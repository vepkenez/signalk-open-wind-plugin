<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Open Wind: Wind & Mast Display</title>
  <!-- Load SignalK client library - try multiple sources -->
  <script>
    (function() {
      // Try multiple CDN sources in order
      const cdnSources = [
        'https://unpkg.com/@signalk/client@1.1.0/dist/signalk-client.min.js',
        'https://cdn.jsdelivr.net/npm/@signalk/client@1.1.0/dist/signalk-client.min.js',
        'https://cdn.skypack.dev/@signalk/client@1.1.0'
      ];
      
      let currentSourceIndex = 0;
      
      function tryLoadScript() {
        if (currentSourceIndex >= cdnSources.length) {
          console.error('All CDN sources failed. Trying to use WebSocket directly...');
          // Fallback: try to connect directly via WebSocket
          window.dispatchEvent(new Event('signalk-client-error'));
          return;
        }
        
        const script = document.createElement('script');
        script.src = cdnSources[currentSourceIndex];
        script.async = true;
        
        script.onload = function() {
          console.log('SignalK client script loaded from:', cdnSources[currentSourceIndex]);
          // Trigger initialization check after a short delay
          setTimeout(function() {
            if (typeof window.signalk !== 'undefined' && window.signalk.Client) {
              console.log('SignalK client library is available');
              window.dispatchEvent(new Event('signalk-client-loaded'));
            } else if (typeof window.SignalK !== 'undefined' && window.SignalK.Client) {
              console.log('SignalK client library is available (alternative namespace)');
              window.dispatchEvent(new Event('signalk-client-loaded'));
            } else {
              console.error('Script loaded but SignalK client not found in window object');
              // Try next source
              currentSourceIndex++;
              tryLoadScript();
            }
          }, 100);
        };
        
        script.onerror = function() {
          console.warn('Failed to load from:', cdnSources[currentSourceIndex]);
          currentSourceIndex++;
          tryLoadScript();
        };
        
        document.head.appendChild(script);
      }
      
      tryLoadScript();
    })();
  </script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      color: white;
      margin-bottom: 30px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      font-size: 2.5em;
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 30px;
      margin-bottom: 30px;
    }

    .panel {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .panel-title {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 20px;
      color: #667eea;
      text-align: center;
    }

    /* Wind Direction Compass */
    .compass-container {
      width: 300px;
      height: 300px;
      position: relative;
      margin: 20px auto;
    }

    .compass-face {
      width: 100%;
      height: 100%;
      border: 8px solid #333;
      border-radius: 50%;
      background: radial-gradient(circle, #f0f0f0 0%, #e0e0e0 100%);
      position: relative;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
    }

    .compass-markers {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
    }

    .compass-marker {
      position: absolute;
      width: 3px;
      height: 20px;
      background: #333;
      left: 50%;
      top: 0;
      transform-origin: bottom center;
      transform: translateX(-50%);
    }

    .compass-marker.major {
      width: 4px;
      height: 30px;
      background: #000;
    }

    .compass-label {
      position: absolute;
      font-size: 14px;
      font-weight: bold;
      color: #333;
      transform: translate(-50%, -50%);
    }

    .wind-arrow {
      position: absolute;
      width: 8px;
      height: 120px;
      background: linear-gradient(to bottom, #4CAF50 0%, #8BC34A 100%);
      left: 50%;
      top: 50%;
      transform-origin: bottom center;
      transform: translateX(-50%) translateY(-100%) rotate(0deg);
      border-radius: 4px 4px 0 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      z-index: 10;
    }

    .wind-arrow::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 10px solid #4CAF50;
    }

    .compass-center {
      position: absolute;
      width: 30px;
      height: 30px;
      background: #333;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 15;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    /* Mast Rotation Indicator */
    .mast-container {
      width: 200px;
      height: 400px;
      position: relative;
      margin: 20px auto;
      background: linear-gradient(to bottom, #87CEEB 0%, #4682B4 100%);
      border-radius: 10px;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
    }

    .mast {
      position: absolute;
      width: 20px;
      height: 350px;
      background: linear-gradient(to right, #8B7355 0%, #A0826D 50%, #8B7355 100%);
      left: 50%;
      top: 20px;
      transform-origin: center bottom;
      transform: translateX(-50%) rotate(0deg);
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.4);
      transition: transform 0.3s ease-out;
      z-index: 5;
    }

    .mast::before {
      content: '';
      position: absolute;
      width: 30px;
      height: 30px;
      background: #FFD700;
      border-radius: 50%;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .mast-base {
      position: absolute;
      width: 60px;
      height: 40px;
      background: #654321;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      border-radius: 5px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.4);
    }

    .rotation-scale {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
    }

    .scale-mark {
      position: absolute;
      width: 2px;
      height: 15px;
      background: rgba(255,255,255,0.7);
      left: 50%;
      transform-origin: bottom center;
      transform: translateX(-50%);
    }

    .scale-mark.major {
      width: 3px;
      height: 25px;
      background: rgba(255,255,255,0.9);
    }

    /* Data Display */
    .data-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      width: 100%;
      margin-top: 20px;
    }

    .data-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .data-label {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .data-value {
      font-size: 2em;
      font-weight: bold;
      color: #333;
    }

    .data-unit {
      font-size: 0.6em;
      color: #999;
      margin-left: 5px;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      background: #ccc;
    }

    .status-indicator.connected {
      background: #4CAF50;
      box-shadow: 0 0 10px #4CAF50;
    }

    .status-indicator.disconnected {
      background: #f44336;
    }

    .status-bar {
      background: white;
      border-radius: 10px;
      padding: 15px 30px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      margin-top: 20px;
    }

    @media (max-width: 768px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
      
      .compass-container, .mast-container {
        width: 250px;
        height: 250px;
      }
      
      .mast-container {
        height: 350px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸŒŠ Open Wind Display</h1>
    
    <div class="dashboard">
      <!-- Wind Direction Panel -->
      <div class="panel">
        <div class="panel-title">Wind Direction</div>
        <div class="compass-container">
          <div class="compass-face">
            <div class="compass-markers" id="compassMarkers"></div>
            <div class="wind-arrow" id="windArrow"></div>
            <div class="compass-center"></div>
          </div>
        </div>
        <div class="data-grid">
          <div class="data-item">
            <div class="data-label">Wind Angle</div>
            <div class="data-value">
              <span id="windAngle">--</span>
              <span class="data-unit">Â°</span>
            </div>
          </div>
          <div class="data-item">
            <div class="data-label">Wind Speed</div>
            <div class="data-value">
              <span id="windSpeed">--</span>
              <span class="data-unit">kts</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Mast Rotation Panel -->
      <div class="panel">
        <div class="panel-title">Mast Rotation</div>
        <div class="mast-container">
          <div class="rotation-scale" id="rotationScale"></div>
          <div class="mast" id="mast"></div>
          <div class="mast-base"></div>
        </div>
        <div class="data-grid">
          <div class="data-item">
            <div class="data-label">Rotation</div>
            <div class="data-value">
              <span id="mastRotation">--</span>
              <span class="data-unit">Â°</span>
            </div>
          </div>
          <div class="data-item">
            <div class="data-label">Sensor Yaw</div>
            <div class="data-value">
              <span id="sensorYaw">--</span>
              <span class="data-unit">Â°</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="status-bar">
      <span class="status-indicator disconnected" id="statusIndicator"></span>
      <span id="statusText">Connecting to SignalK...</span>
    </div>
  </div>

  <script>
    // Wait for SignalK client library to load
    let client;
    let statusIndicator, statusText;
    
    // Update status function - available early
    function updateStatus(connected) {
      if (!statusIndicator) statusIndicator = document.getElementById('statusIndicator');
      if (!statusText) statusText = document.getElementById('statusText');
      if (statusIndicator && statusText) {
        if (connected) {
          statusIndicator.className = 'status-indicator connected';
          statusText.textContent = 'Connected to SignalK';
        } else {
          statusIndicator.className = 'status-indicator disconnected';
          statusText.textContent = 'Disconnected from SignalK';
        }
      }
    }
    
    function initSignalKClient() {
      // Check various possible ways the client library might be exposed
      let ClientClass = null;
      
      // Try window.signalk.Client (most common)
      if (typeof window.signalk !== 'undefined' && window.signalk.Client) {
        ClientClass = window.signalk.Client;
      }
      // Try window.SignalK.Client
      else if (typeof window.SignalK !== 'undefined' && window.SignalK.Client) {
        ClientClass = window.SignalK.Client;
      }
      // Try direct window.Client (unlikely but possible)
      else if (typeof window.Client !== 'undefined') {
        ClientClass = window.Client;
      }
      // Try @signalk/client default export
      else if (typeof signalk !== 'undefined' && signalk.Client) {
        ClientClass = signalk.Client;
      }
      
      if (ClientClass) {
        try {
          client = new ClientClass();
          console.log('SignalK client initialized successfully');
          startApp();
        } catch (error) {
          console.error('Error creating SignalK client:', error);
          updateStatus(false);
          const st = document.getElementById('statusText');
          if (st) st.textContent = 'Error initializing SignalK client: ' + error.message;
        }
      } else {
        // Debug: log what's actually available
        const signalKeys = Object.keys(window).filter(k => 
          k.toLowerCase().includes('signal') || 
          k.toLowerCase().includes('client') ||
          k === 'signalk' || k === 'SignalK'
        );
        console.error('SignalK client library not found. Available relevant globals:', signalKeys);
        console.log('window.signalk:', typeof window.signalk, window.signalk);
        console.log('window.SignalK:', typeof window.SignalK, window.SignalK);
        updateStatus(false);
        const st = document.getElementById('statusText');
        if (st) st.textContent = 'SignalK client library failed to load. Check console for details.';
      }
    }
    
    // DOM element references - need to be accessible to all functions
    let windArrow, windAngle, windSpeed, mast, mastRotation, sensorYaw;
    
    function updateWindDisplay(angleRad, speedMs) {
      if (!windArrow || !windAngle || !windSpeed) {
        windArrow = document.getElementById('windArrow');
        windAngle = document.getElementById('windAngle');
        windSpeed = document.getElementById('windSpeed');
      }
      if (!windArrow || !windAngle || !windSpeed) return;
      
      // Convert angle to degrees (0-360, where 0 is bow, 180 is stern)
      // SignalK uses radians where 0 is bow, positive is starboard
      let angleDeg = parseFloat((angleRad * 180 / Math.PI).toFixed(1));
      
      // Normalize to 0-360
      if (angleDeg < 0) angleDeg += 360;
      
      // Rotate arrow to show wind direction (wind comes FROM this direction)
      windArrow.style.transform = `translateX(-50%) translateY(-100%) rotate(${angleDeg}deg)`;
      windAngle.textContent = angleDeg.toFixed(1);
      
      // Convert m/s to knots
      const speedKnots = (speedMs * 1.943844).toFixed(1);
      windSpeed.textContent = speedKnots;
    }

    function updateMastDisplay(rotationRad, yawRad) {
      if (!mast || !mastRotation || !sensorYaw) {
        mast = document.getElementById('mast');
        mastRotation = document.getElementById('mastRotation');
        sensorYaw = document.getElementById('sensorYaw');
      }
      if (!mast || !mastRotation || !sensorYaw) return;
      
      const rotationDeg = parseFloat((rotationRad * 180 / Math.PI).toFixed(1));
      const yawDeg = parseFloat((yawRad * 180 / Math.PI).toFixed(1));
      
      // Rotate mast (positive rotation = starboard, negative = port)
      mast.style.transform = `translateX(-50%) rotate(${rotationDeg}deg)`;
      mastRotation.textContent = rotationDeg.toFixed(1);
      sensorYaw.textContent = yawDeg.toFixed(1);
    }

    // Handle delta updates (used by both full client and minimal client)
    // Must be defined at top level so both startApp and createMinimalClient can access it
    function handleDelta(delta) {
      let currentWindAngle = null;
      let currentWindSpeed = null;
      let currentMastRotation = null;
      let currentSensorYaw = null;
      
      if (!delta || !delta.updates) return;
      
      delta.updates.forEach(update => {
        if (!update.values) return;
        update.values.forEach(v => {
          // Handle wind angle (radians)
          if (v.path === 'environment.wind.angleApparent') {
            currentWindAngle = v.value;
            if (currentWindSpeed !== null) {
              updateWindDisplay(currentWindAngle, currentWindSpeed);
            }
          }
          // Handle wind angle (degrees - debug path)
          else if (v.path === 'debug-awa-degrees') {
            currentWindAngle = v.value * Math.PI / 180;
            if (currentWindSpeed !== null) {
              updateWindDisplay(currentWindAngle, currentWindSpeed);
            }
          }
          // Handle wind speed (m/s)
          else if (v.path === 'environment.wind.speedApparent') {
            currentWindSpeed = v.value;
            if (currentWindAngle !== null) {
              updateWindDisplay(currentWindAngle, currentWindSpeed);
            }
          }
          // Handle wind speed (knots - debug path)
          else if (v.path === 'debug-wind-speed-knots') {
            currentWindSpeed = v.value / 1.943844; // Convert knots to m/s
            if (currentWindAngle !== null) {
              updateWindDisplay(currentWindAngle, currentWindSpeed);
            }
          }
          // Handle mast rotation (radians)
          else if (v.path === 'sensors.mast.rotation') {
            currentMastRotation = v.value;
            if (currentSensorYaw !== null) {
              updateMastDisplay(currentMastRotation, currentSensorYaw);
            }
          }
          // Handle mast rotation (degrees - debug path)
          else if (v.path === 'debug-mast-rotation-degrees') {
            currentMastRotation = v.value * Math.PI / 180;
            const yaw = currentSensorYaw !== null ? currentSensorYaw : currentMastRotation;
            updateMastDisplay(currentMastRotation, yaw);
          }
          // Handle sensor yaw (radians)
          else if (v.path === 'sensors.mast.yaw') {
            currentSensorYaw = v.value;
            if (currentMastRotation !== null) {
              updateMastDisplay(currentMastRotation, currentSensorYaw);
            }
          }
          // Handle sensor yaw (degrees - debug path)
          else if (v.path === 'debug-sensor-yaw-degrees') {
            currentSensorYaw = v.value * Math.PI / 180;
            if (currentMastRotation !== null) {
              updateMastDisplay(currentMastRotation, currentSensorYaw);
            }
          }
        });
      });
    }

    function startApp() {
    
    // Get DOM elements (using top-level variables)
    windArrow = document.getElementById('windArrow');
    windAngle = document.getElementById('windAngle');
    windSpeed = document.getElementById('windSpeed');
    mast = document.getElementById('mast');
    mastRotation = document.getElementById('mastRotation');
    sensorYaw = document.getElementById('sensorYaw');
    statusIndicator = document.getElementById('statusIndicator');
    statusText = document.getElementById('statusText');

    // Create compass markers
    function createCompassMarkers() {
      const markersContainer = document.getElementById('compassMarkers');
      const labels = ['N', 'E', 'S', 'W'];
      const positions = [0, 90, 180, 270];
      
      for (let i = 0; i < 360; i += 5) {
        const marker = document.createElement('div');
        marker.className = 'compass-marker' + (i % 15 === 0 ? ' major' : '');
        marker.style.transform = `translateX(-50%) rotate(${i}deg)`;
        markersContainer.appendChild(marker);
        
        if (i % 90 === 0) {
          const label = document.createElement('div');
          label.className = 'compass-label';
          label.textContent = labels[i / 90];
          label.style.top = '15px';
          label.style.left = '50%';
          label.style.transform = `translate(-50%, -50%) rotate(${-i}deg)`;
          markersContainer.appendChild(label);
        }
      }
    }

    // Create rotation scale markers
    function createRotationScale() {
      const scaleContainer = document.getElementById('rotationScale');
      for (let i = -45; i <= 45; i += 5) {
        const mark = document.createElement('div');
        mark.className = 'scale-mark' + (i % 15 === 0 ? ' major' : '');
        mark.style.bottom = '50%';
        mark.style.transform = `translateX(-50%) rotate(${i}deg)`;
        scaleContainer.appendChild(mark);
      }
    }


    // Initialize displays
    createCompassMarkers();
    createRotationScale();

    // Connect to SignalK
    // The client will auto-detect the SignalK server from the current page's origin
    try {
      client.connect();
      console.log('Attempting to connect to SignalK...');
    } catch (error) {
      console.error('Error connecting to SignalK:', error);
      updateStatus(false);
    }

    // For full SignalK client library
    if (client && typeof client.onConnect === 'function') {
      client.onConnect = () => {
        updateStatus(true);
        console.log('Connected to SignalK');
        
        // Subscribe to all paths at once using the shared handleDelta function
        client.subscribe(
          [
            { path: 'environment.wind.angleApparent', period: 100 },
            { path: 'environment.wind.speedApparent', period: 100 },
            { path: 'sensors.mast.rotation', period: 100 },
            { path: 'sensors.mast.yaw', period: 100 },
            { path: 'debug-awa-degrees', period: 100 },
            { path: 'debug-wind-speed-knots', period: 100 },
            { path: 'debug-mast-rotation-degrees', period: 100 },
            { path: 'debug-sensor-yaw-degrees', period: 100 }
          ],
          handleDelta
        );
      };
    }

    client.onDisconnect = () => {
      updateStatus(false);
    };

    client.onError = (error) => {
      console.error('SignalK client error:', error);
      updateStatus(false);
    };
    } // end of startApp function
    
    // Listen for script load events
    window.addEventListener('signalk-client-loaded', function() {
      console.log('Received signalk-client-loaded event');
      initSignalKClient();
    });
    
    window.addEventListener('signalk-client-error', function() {
      console.error('Received signalk-client-error event');
      // Try to create a minimal SignalK client using WebSocket directly
      console.log('Attempting to create minimal SignalK client...');
      createMinimalClient();
    });
    
    // Minimal SignalK client implementation using WebSocket directly
    function createMinimalClient() {
      try {
        // Get the current host and port
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsHost = window.location.host;
        const wsUrl = `${wsProtocol}//${wsHost}/signalk/v1/stream`;
        
        console.log('Connecting to SignalK WebSocket:', wsUrl);
        
        // Create a minimal client-like object
        const minimalClient = {
          ws: null,
          subscriptions: [],
          connected: false,
          
          connect: function() {
            try {
              this.ws = new WebSocket(wsUrl);
              
              this.ws.onopen = () => {
                console.log('WebSocket connected to SignalK');
                this.connected = true;
                updateStatus(true);
                // Subscribe to all our paths
                this.subscribe([
                  { path: 'environment.wind.angleApparent', period: 100 },
                  { path: 'environment.wind.speedApparent', period: 100 },
                  { path: 'sensors.mast.rotation', period: 100 },
                  { path: 'sensors.mast.yaw', period: 100 },
                  { path: 'debug-awa-degrees', period: 100 },
                  { path: 'debug-wind-speed-knots', period: 100 },
                  { path: 'debug-mast-rotation-degrees', period: 100 },
                  { path: 'debug-sensor-yaw-degrees', period: 100 }
                ], handleDelta);
              };
              
              this.ws.onmessage = (event) => {
                try {
                  const delta = JSON.parse(event.data);
                  if (delta.updates) {
                    handleDelta(delta);
                  }
                } catch (e) {
                  console.error('Error parsing WebSocket message:', e);
                }
              };
              
              this.ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateStatus(false);
              };
              
              this.ws.onclose = () => {
                console.log('WebSocket closed');
                this.connected = false;
                updateStatus(false);
                // Try to reconnect after 3 seconds
                setTimeout(() => {
                  if (!this.connected) {
                    console.log('Attempting to reconnect...');
                    this.connect();
                  }
                }, 3000);
              };
            } catch (error) {
              console.error('Error creating WebSocket:', error);
              updateStatus(false);
            }
          },
          
          subscribe: function(paths, callback) {
            this.subscriptions.push({ paths, callback });
            if (this.connected && this.ws) {
              const subscribeMsg = {
                context: 'vessels.self',
                subscribe: paths.map(p => ({
                  path: p.path,
                  period: p.period || 1000
                }))
              };
              this.ws.send(JSON.stringify(subscribeMsg));
            }
          }
        };
        
        client = minimalClient;
        client.connect();
        startApp();
        
      } catch (error) {
        console.error('Failed to create minimal client:', error);
        updateStatus(false);
        const st = document.getElementById('statusText');
        if (st) st.textContent = 'SignalK client library failed to load and WebSocket fallback failed. Please check your internet connection.';
      }
    }
    
    
    // Also try immediate initialization if library is already loaded
    function tryInit() {
      if (typeof window.signalk !== 'undefined' && window.signalk.Client) {
        console.log('SignalK client already available, initializing immediately');
        initSignalKClient();
      } else if (typeof window.SignalK !== 'undefined' && window.SignalK.Client) {
        console.log('SignalK client already available (alternative namespace), initializing immediately');
        initSignalKClient();
      } else {
        // Wait a bit and try again, or wait for the event
        setTimeout(() => {
          if (!client) {
            console.log('Still waiting for SignalK client library...');
          }
        }, 1000);
      }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', tryInit);
    } else {
      tryInit();
    }
  </script>
</body>
</html>
