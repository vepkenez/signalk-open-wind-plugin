<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Open Wind Display</title>
  <script>
    (function() {
      const cdnSources = [
        'https://unpkg.com/@signalk/client@1.1.0/dist/signalk-client.min.js',
        'https://cdn.jsdelivr.net/npm/@signalk/client@1.1.0/dist/signalk-client.min.js',
        'https://cdn.skypack.dev/@signalk/client@1.1.0'
      ];
      let currentSourceIndex = 0;
      function tryLoadScript() {
        if (currentSourceIndex >= cdnSources.length) {
          window.dispatchEvent(new Event('signalk-client-error'));
          return;
        }
        const script = document.createElement('script');
        script.src = cdnSources[currentSourceIndex];
        script.async = true;
        script.onload = function() {
          setTimeout(function() {
            if (typeof window.signalk !== 'undefined' && window.signalk.Client) {
              window.dispatchEvent(new Event('signalk-client-loaded'));
            } else if (typeof window.SignalK !== 'undefined' && window.SignalK.Client) {
              window.dispatchEvent(new Event('signalk-client-loaded'));
            } else {
              currentSourceIndex++;
              tryLoadScript();
            }
          }, 100);
        };
        script.onerror = function() {
          currentSourceIndex++;
          tryLoadScript();
        };
        document.head.appendChild(script);
      }
      tryLoadScript();
    })();
  </script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #1a1a2e;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      color: #e0e0e0;
    }

    .container {
      max-width: 600px;
      width: 100%;
    }

    h1 {
      text-align: center;
      color: #e0e0e0;
      margin-bottom: 20px;
      font-size: 1.8em;
      font-weight: 300;
      letter-spacing: 2px;
    }

    .panel {
      background: #16213e;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Toggle switch */
    .toggle-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      font-size: 0.85em;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #8899aa;
    }
    .toggle-row .active { color: #64ffda; font-weight: 600; }
    .toggle-switch {
      position: relative;
      width: 48px;
      height: 26px;
    }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute;
      inset: 0;
      background: #2a3a5c;
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .toggle-slider::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      left: 3px;
      bottom: 3px;
      background: #64ffda;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    .toggle-switch input:checked + .toggle-slider::before {
      transform: translateX(22px);
    }

    /* SVG compass */
    .compass-wrap {
      width: 100%;
      max-width: 460px;
      aspect-ratio: 1;
      position: relative;
    }
    .compass-wrap svg {
      width: 100%;
      height: 100%;
    }

    /* Legend */
    .legend {
      display: flex;
      gap: 18px;
      flex-wrap: wrap;
      justify-content: center;
      margin: 14px 0 8px;
      font-size: 0.78em;
      color: #8899aa;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .legend-swatch {
      width: 14px;
      height: 4px;
      border-radius: 2px;
    }
    .legend-swatch.dashed {
      background: repeating-linear-gradient(90deg, currentColor 0 4px, transparent 4px 7px);
      height: 3px;
    }

    /* Data readout grid */
    .data-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
      width: 100%;
      margin-top: 16px;
    }
    .data-item {
      background: #1a1a2e;
      padding: 12px 8px;
      border-radius: 10px;
      text-align: center;
    }
    .data-label {
      font-size: 0.7em;
      color: #667;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .data-value {
      font-size: 1.5em;
      font-weight: 700;
      color: #e0e0e0;
      font-variant-numeric: tabular-nums;
    }
    .data-unit {
      font-size: 0.5em;
      color: #556;
      margin-left: 2px;
    }

    /* Status bar */
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 14px;
      padding: 10px 16px;
      background: #16213e;
      border-radius: 10px;
      font-size: 0.78em;
      color: #556;
    }
    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
      vertical-align: middle;
    }
    .status-dot.green  { background: #4CAF50; box-shadow: 0 0 6px #4CAF50; }
    .status-dot.red    { background: #f44336; }
    .status-dot.yellow { background: #ff9800; box-shadow: 0 0 4px #ff9800; }
    .status-dot.grey   { background: #555; }

    @media (max-width: 480px) {
      .compass-wrap { max-width: 340px; }
      .data-grid { grid-template-columns: repeat(3, 1fr); }
      .data-value { font-size: 1.2em; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Open Wind</h1>

  <div class="panel">
    <div class="toggle-row">
      <span id="labelGlobal" class="active">Global</span>
      <label class="toggle-switch">
        <input type="checkbox" id="modeToggle">
        <span class="toggle-slider"></span>
      </label>
      <span id="labelBoat">Boat Relative</span>
    </div>

    <div class="compass-wrap">
      <svg viewBox="-200 -200 400 400" id="compassSvg">
        <defs>
          <marker id="arrowHead" markerWidth="10" markerHeight="8" refX="5" refY="4" orient="auto">
            <path d="M0,0 L10,4 L0,8 Z" fill="#4CAF50"/>
          </marker>
        </defs>

        <!-- Compass face -->
        <circle cx="0" cy="0" r="190" fill="#0f1a30" stroke="#2a3a5c" stroke-width="3"/>

        <!-- Compass rose: ticks + labels (rotated as a group) -->
        <g id="compassRose"></g>

        <!-- Sensor yaw line (orange dashed) -->
        <line id="sensorYawLine" x1="0" y1="0" x2="0" y2="-180"
              stroke="#ff9800" stroke-width="2" stroke-dasharray="6,4" opacity="0.7"/>

        <!-- Wind arrow (green) -->
        <g id="windArrowG">
          <line x1="0" y1="0" x2="0" y2="-170" stroke="#4CAF50" stroke-width="4" stroke-linecap="round"/>
          <polygon points="0,-182 -7,-166 7,-166" fill="#4CAF50"/>
        </g>

        <!-- Boat shape group (hull + mast cross) -->
        <g id="boatGroup">
          <path d="M 0,-38 C 10,-35 16,-18 16,8 L 14,26 Q 0,36 -14,26 L -16,8 C -16,-18 -10,-35 0,-38 Z"
                fill="none" stroke="#8899aa" stroke-width="2.5" stroke-linejoin="round"/>
          <!-- Centerline -->
          <line x1="0" y1="-30" x2="0" y2="28" stroke="#8899aa" stroke-width="0.8" opacity="0.4"/>
          <!-- Mast cross -->
          <g id="mastCross">
            <line x1="0" y1="-14" x2="0" y2="14" stroke="#ff5252" stroke-width="3" stroke-linecap="round"/>
            <line x1="-14" y1="0" x2="14" y2="0" stroke="#ff5252" stroke-width="3" stroke-linecap="round"/>
          </g>
        </g>

        <!-- Center dot -->
        <circle cx="0" cy="0" r="4" fill="#64ffda"/>
      </svg>
    </div>

    <div class="legend">
      <span class="legend-item"><span class="legend-swatch" style="background:#8899aa"></span>Boat / Heading</span>
      <span class="legend-item"><span class="legend-swatch" style="background:#ff5252"></span>Mast Rotation</span>
      <span class="legend-item"><span class="legend-swatch" style="background:#4CAF50"></span>Apparent Wind</span>
      <span class="legend-item"><span class="legend-swatch dashed" style="color:#ff9800"></span>Sensor Yaw</span>
    </div>

    <div class="data-grid">
      <div class="data-item">
        <div class="data-label">Heading</div>
        <div class="data-value"><span id="valHeading">--</span><span class="data-unit">&deg;</span></div>
      </div>
      <div class="data-item">
        <div class="data-label">Sensor Yaw</div>
        <div class="data-value"><span id="valSensorYaw">--</span><span class="data-unit">&deg;</span></div>
      </div>
      <div class="data-item">
        <div class="data-label">Mast Rot.</div>
        <div class="data-value"><span id="valMastRot">--</span><span class="data-unit">&deg;</span></div>
      </div>
      <div class="data-item">
        <div class="data-label">AWA</div>
        <div class="data-value"><span id="valAWA">--</span><span class="data-unit">&deg;</span></div>
      </div>
      <div class="data-item">
        <div class="data-label">Wind Speed</div>
        <div class="data-value"><span id="valWindSpeed">--</span><span class="data-unit">kts</span></div>
      </div>
    </div>
  </div>

  <div class="status-bar">
    <span id="pluginVersion">Open Wind --</span>
    <span id="bleStatus"><span class="status-dot grey"></span>BLE: --</span>
    <span id="skStatus"><span class="status-dot red"></span>SignalK: Connecting</span>
  </div>
</div>

<script>
  // ── State ──────────────────────────────────────────────
  let client;
  let globalMode = true;

  let heading = null;       // boat heading (rad, global)
  let sensorYaw = null;     // sensor compass (rad, global)
  let mastRotation = null;  // mast rot relative to boat (rad)
  let windAngle = null;     // apparent wind angle, boat-relative (rad)
  let windSpeed = null;     // m/s
  let bleStatusVal = null;
  let pluginVersionVal = null;

  // ── DOM refs ───────────────────────────────────────────
  const $ = id => document.getElementById(id);

  // ── Build compass rose (tick marks + labels) ───────────
  function buildCompassRose() {
    const g = $('compassRose');
    const labels = { 0: 'N', 90: 'E', 180: 'S', 270: 'W' };
    for (let deg = 0; deg < 360; deg += 5) {
      const isMajor = deg % 15 === 0;
      const r1 = isMajor ? 165 : 172;
      const r2 = 188;
      const rad = deg * Math.PI / 180;
      const x1 = r1 * Math.sin(rad), y1 = -r1 * Math.cos(rad);
      const x2 = r2 * Math.sin(rad), y2 = -r2 * Math.cos(rad);
      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line.setAttribute('x1', x1); line.setAttribute('y1', y1);
      line.setAttribute('x2', x2); line.setAttribute('y2', y2);
      line.setAttribute('stroke', isMajor ? '#5a6a8a' : '#3a4a6a');
      line.setAttribute('stroke-width', isMajor ? '2' : '1');
      g.appendChild(line);

      if (labels[deg] !== undefined) {
        const lr = 150;
        const tx = lr * Math.sin(rad), ty = -lr * Math.cos(rad);
        const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        txt.setAttribute('x', tx); txt.setAttribute('y', ty);
        txt.setAttribute('text-anchor', 'middle');
        txt.setAttribute('dominant-baseline', 'central');
        txt.setAttribute('fill', deg === 0 ? '#ff5252' : '#8899aa');
        txt.setAttribute('font-size', '18');
        txt.setAttribute('font-weight', 'bold');
        txt.textContent = labels[deg];
        g.appendChild(txt);
      }
    }
  }

  // ── Helpers ────────────────────────────────────────────
  function rad2deg(r) { return r * 180 / Math.PI; }
  function normDeg(d) { return ((d % 360) + 360) % 360; }
  function fmtAngle(rad, signed) {
    if (rad === null) return '--';
    let d = rad2deg(rad);
    if (signed) {
      if (d > 180) d -= 360;
      return (d >= 0 ? '+' : '') + d.toFixed(1);
    }
    return normDeg(d).toFixed(1);
  }

  // ── Display update ─────────────────────────────────────
  function updateDisplay() {
    const rose = $('compassRose');
    const boat = $('boatGroup');
    const cross = $('mastCross');
    const arrow = $('windArrowG');
    const yawLine = $('sensorYawLine');

    const hDeg = heading !== null ? normDeg(rad2deg(heading)) : 0;
    const hasHeading = heading !== null;

    if (globalMode) {
      // N at top: rose fixed, boat rotates to heading
      rose.setAttribute('transform', '');
      boat.setAttribute('transform', hasHeading ? `rotate(${hDeg})` : '');
      if (windAngle !== null && hasHeading) {
        const globalWind = hDeg + rad2deg(windAngle);
        arrow.setAttribute('transform', `rotate(${normDeg(globalWind)})`);
        arrow.setAttribute('opacity', '1');
      } else {
        arrow.setAttribute('opacity', '0.2');
      }
      if (sensorYaw !== null) {
        yawLine.setAttribute('transform', `rotate(${normDeg(rad2deg(sensorYaw))})`);
        yawLine.setAttribute('opacity', '0.7');
      } else {
        yawLine.setAttribute('opacity', '0.15');
      }
    } else {
      // Bow at top: boat fixed, rose counter-rotates
      rose.setAttribute('transform', hasHeading ? `rotate(${-hDeg})` : '');
      boat.setAttribute('transform', '');
      if (windAngle !== null) {
        arrow.setAttribute('transform', `rotate(${normDeg(rad2deg(windAngle))})`);
        arrow.setAttribute('opacity', '1');
      } else {
        arrow.setAttribute('opacity', '0.2');
      }
      if (sensorYaw !== null && hasHeading) {
        const relYaw = rad2deg(sensorYaw) - hDeg;
        yawLine.setAttribute('transform', `rotate(${normDeg(relYaw)})`);
        yawLine.setAttribute('opacity', '0.7');
      } else {
        yawLine.setAttribute('opacity', '0.15');
      }
    }

    // Mast cross always rotates relative to boat
    if (mastRotation !== null) {
      cross.setAttribute('transform', `rotate(${rad2deg(mastRotation)})`);
    }

    // Numeric readout
    $('valHeading').textContent = heading !== null ? normDeg(rad2deg(heading)).toFixed(1) : '--';
    $('valSensorYaw').textContent = sensorYaw !== null ? normDeg(rad2deg(sensorYaw)).toFixed(1) : '--';
    $('valMastRot').textContent = fmtAngle(mastRotation, true);
    $('valAWA').textContent = fmtAngle(windAngle, true);
    $('valWindSpeed').textContent = windSpeed !== null ? (windSpeed * 1.943844).toFixed(1) : '--';
  }

  // ── Toggle ─────────────────────────────────────────────
  function initToggle() {
    const toggle = $('modeToggle');
    const labelG = $('labelGlobal');
    const labelB = $('labelBoat');
    toggle.addEventListener('change', () => {
      globalMode = !toggle.checked;
      labelG.className = globalMode ? 'active' : '';
      labelB.className = globalMode ? '' : 'active';
      updateDisplay();
    });
  }

  // ── Status helpers ─────────────────────────────────────
  function updateSkStatus(connected) {
    const el = $('skStatus');
    if (connected) {
      el.innerHTML = '<span class="status-dot green"></span>SignalK: Connected';
    } else {
      el.innerHTML = '<span class="status-dot red"></span>SignalK: Disconnected';
    }
  }

  function updateBleStatusUI() {
    const el = $('bleStatus');
    if (!bleStatusVal) {
      el.innerHTML = '<span class="status-dot grey"></span>BLE: --';
      return;
    }
    const map = {
      connected:    { cls: 'green',  text: 'Connected' },
      scanning:     { cls: 'yellow', text: 'Scanning...' },
      disconnected: { cls: 'red',    text: 'Disconnected' },
      not_found:    { cls: 'red',    text: 'Not Found' }
    };
    const s = map[bleStatusVal] || { cls: 'grey', text: bleStatusVal };
    el.innerHTML = `<span class="status-dot ${s.cls}"></span>BLE: ${s.text}`;
  }

  function updatePluginVersionUI() {
    $('pluginVersion').textContent = pluginVersionVal ? `Open Wind v${pluginVersionVal}` : 'Open Wind --';
  }

  // ── Signal K delta handler ─────────────────────────────
  function handleDelta(delta) {
    if (!delta || !delta.updates) return;
    let changed = false;

    delta.updates.forEach(update => {
      if (!update.values) return;
      update.values.forEach(v => {
        switch (v.path) {
          case 'navigation.headingMagnetic':
            heading = v.value; changed = true; break;
          case 'environment.wind.angleApparent':
            windAngle = v.value; changed = true; break;
          case 'environment.wind.speedApparent':
            windSpeed = v.value; changed = true; break;
          case 'sensors.mast.rotation':
            mastRotation = v.value; changed = true; break;
          case 'sensors.mast.yaw':
            sensorYaw = v.value; changed = true; break;
          case 'sensors.openwind.bluetoothStatus':
            bleStatusVal = v.value; updateBleStatusUI(); break;
          case 'sensors.openwind.pluginVersion':
            pluginVersionVal = v.value; updatePluginVersionUI(); break;
          // Debug paths (degrees)
          case 'debug-awa-degrees':
            windAngle = v.value * Math.PI / 180; changed = true; break;
          case 'debug-wind-speed-knots':
            windSpeed = v.value / 1.943844; changed = true; break;
          case 'debug-mast-rotation-degrees':
            mastRotation = v.value * Math.PI / 180; changed = true; break;
          case 'debug-sensor-yaw-degrees':
            sensorYaw = v.value * Math.PI / 180; changed = true; break;
        }
      });
    });

    if (changed) updateDisplay();
  }

  // ── Signal K subscription list ─────────────────────────
  const SUBSCRIBE_PATHS = [
    { path: 'navigation.headingMagnetic', period: 200 },
    { path: 'environment.wind.angleApparent', period: 100 },
    { path: 'environment.wind.speedApparent', period: 100 },
    { path: 'sensors.mast.rotation', period: 100 },
    { path: 'sensors.mast.yaw', period: 100 },
    { path: 'sensors.openwind.bluetoothStatus', period: 2000 },
    { path: 'sensors.openwind.pluginVersion', period: 10000 },
    { path: 'debug-awa-degrees', period: 100 },
    { path: 'debug-wind-speed-knots', period: 100 },
    { path: 'debug-mast-rotation-degrees', period: 100 },
    { path: 'debug-sensor-yaw-degrees', period: 100 },
  ];

  // ── startApp (called after client is ready) ────────────
  function startApp() {
    buildCompassRose();
    initToggle();

    try {
      client.connect();
    } catch (error) {
      console.error('Error connecting to SignalK:', error);
      updateSkStatus(false);
    }

    if (client && typeof client.onConnect === 'function') {
      client.onConnect = () => {
        updateSkStatus(true);
        client.subscribe(SUBSCRIBE_PATHS, handleDelta);
      };
    }
    client.onDisconnect = () => updateSkStatus(false);
    client.onError = () => updateSkStatus(false);
  }

  // ── Client initialisation ──────────────────────────────
  function initSignalKClient() {
    let ClientClass = null;
    if (typeof window.signalk !== 'undefined' && window.signalk.Client) {
      ClientClass = window.signalk.Client;
    } else if (typeof window.SignalK !== 'undefined' && window.SignalK.Client) {
      ClientClass = window.SignalK.Client;
    } else if (typeof signalk !== 'undefined' && signalk.Client) {
      ClientClass = signalk.Client;
    }
    if (ClientClass) {
      try {
        client = new ClientClass();
        startApp();
      } catch (error) {
        console.error('Error creating SignalK client:', error);
        updateSkStatus(false);
      }
    } else {
      updateSkStatus(false);
    }
  }

  // ── Minimal WebSocket client (fallback) ────────────────
  function createMinimalClient() {
    try {
      const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsHost = window.location.host;
      const wsUrl = `${wsProtocol}//${wsHost}/signalk/v1/stream`;

      const minimalClient = {
        ws: null,
        connected: false,
        connect: function() {
          this.ws = new WebSocket(wsUrl);
          this.ws.onopen = () => {
            this.connected = true;
            updateSkStatus(true);
            this.subscribe(SUBSCRIBE_PATHS, handleDelta);
          };
          this.ws.onmessage = (event) => {
            try {
              const delta = JSON.parse(event.data);
              if (delta.updates) handleDelta(delta);
            } catch (e) {}
          };
          this.ws.onerror = () => updateSkStatus(false);
          this.ws.onclose = () => {
            this.connected = false;
            updateSkStatus(false);
            setTimeout(() => { if (!this.connected) this.connect(); }, 3000);
          };
        },
        subscribe: function(paths, callback) {
          if (this.connected && this.ws) {
            this.ws.send(JSON.stringify({
              context: 'vessels.self',
              subscribe: paths.map(p => ({ path: p.path, period: p.period || 1000 }))
            }));
          }
        }
      };
      client = minimalClient;
      client.connect();
      startApp();
    } catch (error) {
      console.error('Failed to create minimal client:', error);
      updateSkStatus(false);
    }
  }

  // ── Bootstrap ──────────────────────────────────────────
  window.addEventListener('signalk-client-loaded', () => initSignalKClient());
  window.addEventListener('signalk-client-error', () => createMinimalClient());

  function tryInit() {
    if (typeof window.signalk !== 'undefined' && window.signalk.Client) {
      initSignalKClient();
    } else if (typeof window.SignalK !== 'undefined' && window.SignalK.Client) {
      initSignalKClient();
    }
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', tryInit);
  } else {
    tryInit();
  }
</script>
</body>
</html>
